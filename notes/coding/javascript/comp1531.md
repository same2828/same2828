# Table of Contents

- [Table of Contents](#table-of-contents)
- [NPM](#npm)
  - [NPM vs Yarn Commands](#npm-vs-yarn-commands)
  - [Anatomy of NPM](#anatomy-of-npm)
  - [Setup code repository to use npm](#setup-code-repository-to-use-npm)
  - [Install packages/dependencies](#install-packagesdependencies)
  - [Run Custom Scripts](#run-custom-scripts)
- [NodeJS Built-in Modules](#nodejs-built-in-modules)
- [Multi-files and Importing](#multi-files-and-importing)
  - [Export Single Function (Default Export)](#export-single-function-default-export)
  - [Export Multiple Functions (Named Export)](#export-multiple-functions-named-export)
- [JSON](#json)
  - [JavaScript Object -\> JSON](#javascript-object---json)
  - [JSON -\> JavaScript Object](#json---javascript-object)
- [TypeScript](#typescript)
  - [Type Checking with TypeScript](#type-checking-with-typescript)
  - [Unions](#unions)
  - [Lists](#lists)
  - [Aliases](#aliases)
  - [Optionals](#optionals)
  - [Literals](#literals)
  - [Any (Type)](#any-type)
  - [Functions](#functions)
    - [Return Type Annotations](#return-type-annotations)
  - [Migrating to TypeScript](#migrating-to-typescript)
    - [TypeScript with CLI](#typescript-with-cli)
- [ESLint](#eslint)
  - [Install](#install)
  - [Initialise](#initialise)
  - [Run](#run)
  - [Automatically Fixing Style Issues](#automatically-fixing-style-issues)
  - [Ignoring One-Off Issues](#ignoring-one-off-issues)
  - [Disable](#disable)
  - [Script](#script)
  - [CLI](#cli)
  - [ESLint with Jest](#eslint-with-jest)
  - [ESLint with TypeScript](#eslint-with-typescript)
- [Advanced Functions](#advanced-functions)
  - [3 ways to define functions](#3-ways-to-define-functions)
  - [First-Class Functions](#first-class-functions)
  - [Map, Reduce, Filter](#map-reduce-filter)
  - [Higher-Order Functions](#higher-order-functions)
- [HTTP Server](#http-server)
  - [Networks](#networks)
  - [HTTP](#http)
  - [NodeJS Express Server](#nodejs-express-server)
- [API](#api)
  - [Web API](#web-api)
  - [RESTful API](#restful-api)
  - [Talking to a Web Server](#talking-to-a-web-server)
  - [API Client](#api-client)
  - [Requests Library](#requests-library)
  - [Working with Jest](#working-with-jest)
  - [Tips](#tips)

# NPM

## NPM vs Yarn Commands

| Command                                  | npm                                  | yarn                           |
| ---------------------------------------- | ------------------------------------ | ------------------------------ |
| Initialise                               | `npm init`                           | `yarn init`                    |
| Install dependencies from `package.json` | `npm install`                        | `yarn \|\| yarn install`       |
| Install package                          | `npm install [package]`              | `yarn add [package]`           |
| Install dev package                      | `npm install --save-dev [package]`   | `yarn add --dev [package]`     |
| Uninstall package                        | `npm uninstall [package]`            | `yarn remove [package]`        |
| Uninstall dev package                    | `npm uninstall --save-dev [package]` | `yarn remove [package]`        |
| Update                                   | `npm update`                         | `yarn upgrade`                 |
| Update package                           | `npm update [package]`               | `yarn upgrade [package]`       |
| Global install package                   | `npm install --global [package]`     | `yarn global add [package]`    |
| Global uninstall package                 | `npm uninstall --global [package]`   | `yarn global remove [package]` |

## Anatomy of NPM

- The structure of NPM involves a few key files and folders:
  - `package.json`
    - Where we store meta data about our project including a list of dependencies to install
    - Changes are always committed to git
    - [Read about ~ and ^ symbols](https://stackoverflow.com/questions/22343224/whats-the-difference-between-tilde-and-caret-in-package-json)
  - `package-lock.json`
    - Where we store versioning information about dependencies to ensure everyone has the right versions
    - Changes are always committed to git
  - `node_modules/`
    - Where the dependencies are installed locally
    - Changes are NEVER committed to git

## Setup code repository to use npm

```
npm init
yarn init
```

## Install packages/dependencies

```
npm install [package]
npm install date-fns

yarn add [package]
yarn add date-fns
```

## Run Custom Scripts

- Add scripts to `package.json`
- `npm run scriptName`

```json
{
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    // Run with `npm run hayden`
    "hayden": "echo 'Hi Hayden!'"
  }
}
```

# NodeJS Built-in Modules

| Module           | Description                                                |
| ---------------- | ---------------------------------------------------------- |
| `assert`         | Provides a set of assertion tests                          |
| `buffer`         | To handle binary data                                      |
| `child_process`  | To run a child process                                     |
| `cluster`        | To split a single Node process into multiple processes     |
| `crypto`         | To handle OpenSSL cryptographic functions                  |
| `dgram`          | Provides implementation of UDP datagram sockets            |
| `dns`            | To do DNS lookups and name resolution functions            |
| `domain`         | Deprecated. To handle unhandled errors                     |
| `events`         | To handle events                                           |
| `fs`             | To handle the file system                                  |
| `http`           | To make Node.js act as an HTTP server                      |
| `https`          | To make Node.js act as an HTTPS server.                    |
| `net`            | To create servers and clients                              |
| `os`             | Provides information about the operation system            |
| `path`           | To handle file paths                                       |
| `punycode`       | Deprecated. A character encoding scheme                    |
| `querystring`    | To handle URL query strings                                |
| `readline`       | To handle readable streams one line at the time            |
| `stream`         | To handle streaming data                                   |
| `string_decoder` | To decode buffer objects into strings                      |
| `timers`         | To execute a function after a given number of milliseconds |
| `tls`            | To implement TLS and SSL protocols                         |
| `tty`            | Provides classes used by a text terminal                   |
| `url`            | To parse URL strings                                       |
| `util`           | To access utility functions                                |
| `v8`             | To access information about V8 (the JavaScript engine)     |
| `vm`             | To compile JavaScript code in a virtual machine            |
| `zlib`           | To compress or decompress files                            |

- Most Commonly Used
  - `fs`
    - Opening files
  - `path`
    - Getting file paths
- [Read more](https://www.w3schools.com/nodejs/ref_modules.asp)
- Code examples

  ```js
  import fs from 'fs';
  import path from 'path';
  console.log(path.resolve('./'));
  ```

# Multi-files and Importing

## Export Single Function (Default Export)

- `export default functionName`
- `import functionName from ./file.js`
- Example 1

  ```js
  // File 1
  function manyString(repeat, str) {
    let outString = '';
    for (let i = 0; i < repeat; i++) {
      outString += str;
    }
    return outString;
  }

  export default manyString;
  ```

  ```js
  // File 2
  import manyString from './file1.js';
  console.log(manyString(5, 'hello '));
  // hello hello hello hello hello
  ```

- Example 2

  - Note when using `export default functionName`, when we import that function in another file, we can **rename** that function (to avoid name conficts)

  ```js
  // File 1
  const func1 = () => {
    console.log('hi');
  };

  export default func1;
  ```

  ```js
  // File 2
  import renamedFunc from './file1.js';
  differentName();
  ```

## Export Multiple Functions (Named Export)

- `export { function1, function2 }`
- `import { function1, function2 } from ./file.js`
- Note this is **NOT** exporting an object
- Example 1

  ```js
  // File 1
  const manyString = (repeat, str) => {
    let outString = '';
    for (let i = 0; i < repeat; i++) {
      outString += str;
    }
    return outString;
  };

  function addBrackets(string) {
    return `(${string})`;
  }

  export { manyString, addBrackets };
  // export { manyString };
  // export { addBrackets };
  ```

  ```js
  // File 2
  import { addBrackets, manyString } from './file1.js';

  const bracketed = addBrackets('hello');
  const repeated = manyString(5, bracketed);
  console.log(repeated);
  // (hello)(hello)(hello)(hello)(hello)
  ```

  ```js
  // File 3
  import multiExport from './file1.js';

  const bracketed = multiExport.addBrackets('hello');
  const repeated = multiExport.manyString(5, bracketed);
  console.log(repeated);
  // (hello)(hello)(hello)(hello)(hello)
  ```

- Example 2

  ```js
  // File 1
  const func1 = () => {
    console.log('hi');
  };

  const func2 = () => {
    console.log('bye');
  };

  export { func1, func2 };
  ```

  ```js
  // File 2
  import { func1 as printHi, func2 as printBye } from './file1.js';
  printHi();
  printBye();
  ```

# JSON

- No trailing commas allowed
- Object keys must be strings and quoted using double quotes (include apostrophes)
- Example

  ```json
  {
    "locations": [
      {
        "suburb": "Kensington",
        "postcode": 2033
      },
      {
        "suburb": "Mascot",
        "postcode": 2020
      },
      {
        "suburb": "Sydney CBD",
        "postcode": 2000
      }
    ]
  }
  ```

## JavaScript Object -> JSON

- Use `JSON.stringify(jsObject)`
- Example

  ```js
  import fs from 'fs';

  const jsObject = {
    names: [
      {
        first: 'Bob',
        last: 'Carr',
      },
      {
        first: 'Julia',
        last: 'Gillard',
      },
      {
        first: 'Ken',
        last: 'Henry',
      },
    ],
  };

  const jsonData = JSON.stringify(jsObject);
  fs.writeFileSync('export.json', data, { flag: 'w' });
  ```

## JSON -> JavaScript Object

- Use `JSON.parse(jsonData)`
- Example

  ```js
  import fs from 'fs';

  const jsonData = fs.readFileSync('export.json', { flag: 'r' });
  const jsObject = JSON.parse(jsonData);
  console.log(jsObject);
  ```

# TypeScript

- Need to install npm packages `typescript` and `ts-node`
  - `npm install --save-dev typescript ts-node`
- Run code with:
  - `./node_modules/.bin/ts-node fileName.ts`
- More info on types
  - https://www.typescriptlang.org/docs/handbook/2/everyday-types.html

## Type Checking with TypeScript

- Initialise folder
  - `./node_modules/.bin/tsc --init`
- Type check code WITHOUT running code
  - Specific file:
    - `./node_modules/.bin/tsc --noImplicitAny fileName.ts`
  - Whole folder:
    - `./node_modules/.bin/tsc --noImplicitAny`
- Would normally add commands to `package.json` so we can run with `npm`
  - `npm run tsc`
  - `npm run ts-node fileName.ts`
  ```json
  {
    "scripts": {
      "ts-node": "ts-node",
      "tsc": "tsc --noImplicitAny"
    }
  }
  ```

## Unions

- Use `|` between allowed types
- Example
  ```ts
  function printIfReady(ready: boolean | number) {
    if (ready === true || (ready && ready !== 0)) {
      console.log('Ready!');
    }
  }
  printIfReady(1);
  printIfReady(2);
  printIfReady(0);
  printIfReady(true);
  printIfReady(false);
  ```

## Lists

- Example
  ```ts
  function create10List(item: string | number) {
    const arr: Array<string | number> = [];
    for (let i = 0; i < 10; i++) {
      arr.push(item);
    }
    return arr;
  }
  ```

## Aliases

- Define using `type aliasName = allowedTypes;`
- Example

  ```ts
  type ListItem = string | number;

  function create10List(item: ListItem) {
    // 2 ways to declare arrays with aliases
    const arr1: ListItem[] = [];
    const arr2: Array<ListItem> = [];
    for (let i = 0; i < 10; i++) {
      arr1.push(item);
      arr2.push(item);
    }
    return arr1;
  }
  ```

## Optionals

- Add `?` to variable name
- Example

  ```ts
  function substring(str: string, start: number, end?: number) {
    let newString = '';
    const modifiedEnd = end || str.length;
    // const modifiedEnd =  ?? str.length; // Same thing
    // https://stackoverflow.com/questions/51051571/what-is-the-difference-between-using-and-over-a-ternary-operator
    for (let i = start; i < modifiedEnd; i++) {
      newString += str[i];
    }
    return newString;
  }

  console.log(substring('012345', 0, 3));
  console.log(substring('012345', 2));
  // 012
  // 2345
  ```

  ```ts
  type Person = {
    name: string;
    age?: number;
    height?: number;
  };

  const person: Person = {
    name: 'Hayden',
  };

  person.age = 5;
  ```

## Literals

- Define using `type literalName = allowedValues;`
- Example 1

  ```ts
  type visibility = 'Private' | 'Public';
  function createChannel(name: string, visibility: visibility) {
    console.log(name + ': ' + visibility);
  }

  type sumNumber = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9;
  const mySum(a: sumNumber, b: sumNumber) {
    console.log(a + b);
  }
  // Valid
  mySum(7, 8);
  // Invalid
  mySum(11, 12);
  ```

- Example 2

  ```ts
  function printText(s: string, alignment: 'left' | 'right' | 'center') {
    // ...
  }
  printText('Hello, world', 'left');
  ```

- Example 3
  ```ts
  function compare(a: string, b: string): -1 | 0 | 1 {
    return a === b ? 0 : a > b ? 1 : -1;
  }
  ```
- Example 4
  ```ts
  interface Options {
    width: number;
  }
  function configure(x: Options | 'auto') {
    // ...
  }
  configure({ width: 100 });
  configure('auto');
  ```

## Any (Type)

- Allows ANY type
- Example

  ```ts
  // @ts-nocheck

  function hello(name: any): any {
    return `Hello ${name}!`;
  }

  function substring(str: any, start: any, end: any) {
    return null;
  }

  type Person = any;
  const person: Person = {
    name: 'Hayden',
  };
  ```

## Functions

### Return Type Annotations

- Example
  ```ts
  function getFavoriteNumber(): number {
    return 26;
  }
  ```

## Migrating to TypeScript

1. Run `npm install --save-dev ts-jest @types/jest`
   1. This allows Typescript to work with your jest files
2. Run `npm install --save-dev @types/node`
   1. This avoids complicated issues with the types of imports we do
   2. https://stackoverflow.com/questions/31173738/typescript-getting-error-ts2304-cannot-find-name-require
3. Add files `tsconfig.json` and `jest.config.js` with course-provided info in them
4. Update `package.json` to include a script `tsc` that just runs `tsc --noImplicitAny` and `ts-node` that just runs `ts-node`
5. You can also add `npm run tsc` as a step in pipelines

### TypeScript with CLI

```yml
image: comp1531/basic:latest

stages:
  - checks

testing:
  stage: checks
  script:
    - npm run test

typecheck:
  stage: checks
  script:
    - npm run tsc
```

# ESLint

- eslint determines what is and isn't OK by looking at a `.eslintrc` file
  - In our case we're using a file named `.eslintrc.js`

## Install

- `npm install --save-dev eslint`

## Initialise

- `./node_modules/.bin/eslint --init`

## Run

- `./node_modules/.bin/eslint fileName.js`
- If nothing prints to terminal then OK

## Automatically Fixing Style Issues

- Note this overwrites the file
- `./node_modules/.bin/eslint --fix fileName.js`

## Ignoring One-Off Issues

- Add ABOVE line to ignore as comment
  - `// eslint-disable-next-line`
- Same line
  - `// eslint-disable-line ruleBroken`
- [Read more](https://eslint.org/docs/latest/user-guide/configuring/rules#disabling-rules)

## Disable

- Add to top of file as comment
  - `/* eslint-disable */`

## Script

- Add to `package.json`
  ```json
  {
    "scripts": {
      "lint": "eslint \"**/**.js\"",
      "lint-fix": "eslint --fix \"**/**.js\""
    }
  }
  ```
- Check code
  - `npm run lint`
- Check and fix code
  - `npm run lint-fix`

## CLI

- Add to `.gitlab-ci.yml`

```yml
image: comp1531/basic:latest

cache:
  paths:
    - node_modules

stages:
  - checks

testing:
  stage: checks
  script:
    - npm run test

typecheck:
  stage: checks
  script:
    - npm run tsc

linting:
  stage: checks
  script:
    - npm run lint
```

## ESLint with Jest

- `npm install --save-dev eslint-plugin-jest`
  - [Read more](https://www.npmjs.com/package/eslint-plugin-jest)
- Add to `.eslintrc.js`
  ```json
  {
    "plugins": ["jest"],
    "env": { "jest": true }
  }
  ```

## ESLint with TypeScript

- `npm install --save-dev eslint typescript @typescript-eslint/parser @typescript-eslint/eslint-plugin`
  - [Read more](https://typescript-eslint.io/docs/)
- Add to `.eslintrc.js`
  ```js
  {
    parser: '@typescript-eslint/parser',
    plugins: [
      '@typescript-eslint'
    ],
    extends: [
      'eslint:recommended',
      'plugin:@typescript-eslint/recommended'
    ]
  }
  ```

# Advanced Functions

## 3 ways to define functions

- Method 1

  ```js
  function sum(a, b) {
    return a + b;
  }
  ```

- Method 2

  ```js
  const sum = function (a, b) {
    return a + b;
  };
  ```

- Method 3

  ```js
  const sum = (a, b) => {
    return a + b;
  };
  ```

  ```ts
  // IFF function body is SINGLE line
  const sum = (a: number, b: number) => {
    return a + b;
  };
  // Shortcut
  const sum = (a: number, b: number) => a + b;
  ```

## First-Class Functions

- A language has first-class functions when **functions are treated just like any other variable**
- Most notably, functions can be passed into functions just like variables can

  - Variable Definition

    ```js
    const name = 'Hayden';
    console.log(name);
    ```

  - Function Definition
    ```js
    const getName = () => {
      return 'Hayden';
    };
    console.log(getName);
    ```

- Example 1

  ```ts
  type Fmtr = (str: string) => string;

  const addBrackets = (str: string) => `(${str})`;
  const addFullStop = (str: string) => `${str}.`;
  const sayHi = (name: string, format: Fmtr) => `Hello, ${format(name)}!`;

  const result = sayHi('Hayden', addBrackets) + ' -- ' + sayHi('Hayden', addFullStop);

  console.log(result);
  // Hello, (Hayden)! -- Hello, Hayden.!
  ```

- Example 2

  ```ts
  type Fmtr = (str: string) => string;

  const allCaps = (str: string) => `${str.toUpperCase()}`;
  const addBrackets = (str: string) => `(${str})`;

  const names = ['Hayden', 'Giuliana', 'Tom'];

  function formatNames(list: string[], format: Fmtr) {
    const newList: string[] = [];
    for (const name of list) {
      newList.push(format(name));
    }
    return newList;
  }

  const newNames = formatNames(names, addBrackets);
  const newNames2 = formatNames(names, allCaps);
  const newNames3 = formatNames(names, (str) => {
    return `(${str.toUpperCase()})`;
  });
  const newNames4 = formatNames(names, (str: string) => `${str.toUpperCase()}`);
  ```

## Map, Reduce, Filter

- Map = Modify an array
- Reduce = Summarise an array
- Filter = Select from an array

  ```ts
  // Map
  const tutors = ['Simon', 'Teresa', 'Tom', 'Michelle'];
  const newList = tutors.map((str: string) => `${str.toUpperCase()}!!!`);
  console.log(newList);
  ```

  ```ts
  // Filter
  const marks = [65, 72, 81, 40, 56];
  const newList = marks.filter((mark: number) => mark >= 50);
  console.log(newList);
  ```

  ```ts
  // Reduce
  type Student = {
    name: string;
    mark: number;
  };

  const students: Student[] = [
    { name: 'Amy', mark: 55 },
    { name: 'Bob', mark: 43 },
    { name: 'Cap', mark: 34 },
    { name: 'Dex', mark: 23 },
  ];

  const sum = (prev: number, curr: Student) => {
    return prev + curr.mark;
  };

  const totalMarks = students.reduce(sum, 0);
  const totalMarks2 = students.reduce((prev, curr) => prev + curr.mark, 0);
  ```

  ```js
  // Map, Reduce, Filter
  const marks = [39, 43.2, 48.6, 24, 33.6];
  const normalisedMarks = marks.map((m) => (100 * m) / 60);
  const passingMarks = normalisedMarks.filter((m) => m >= 50);
  const total = passingMarks.reduce((a, b) => a + b, 0);
  const average = total / passingMarks.length;
  console.log(average);
  ```

## Higher-Order Functions

- Higher-order Functions are essentially functions that return functions (mini function factories

  - This gets

    ```ts
    const congratWrapper = (markstr: string, name: string) => `Congratulations ${name} on your ${markstr}`;
    const congratMarkPS = (name: string) => congratWrapper('pass', name);
    const congratMarkCR = (name: string) => congratWrapper('credit', name);
    const congratMarkDN = (name: string) => congratWrapper('distinction', name);

    console.log(congratMarkCR('Hayden'));
    ```

  - transformed into this

    ```ts
    function genCongratMark(markstr: string) {
      const ret = function (name: string) {
        return `Congratulations ${name} on your ${markstr}`;
      };
      return ret;
    }

    function genCongratMark2(markstr: string) {
      return (name: string) => `Congratulations ${name} on your ${markstr}`;
    }

    const genCongratMark3 = (markstr: string) => (name: string) => `Congratulations ${name} on your ${markstr}`;

    const congratMarkPS = genCongratMark('pass');
    const congratMarkCR = genCongratMark('credit');
    const congratMarkDN = genCongratMark('distinction');

    console.log(congratMarkCR('Hayden'));
    ```

# HTTP Server

## Networks

- Network: A group of interconnected computers that can communicate
- Internet: A global infrastructure for networking computers around the entire world together
- World Wide Web: A system of documents and resources linked together, accessible via URLs

## HTTP

- HTTP: Hypertext Transfer Protocol
  - Protocol for sending and receiving HTML documents and more
- Web Browser = Client
  - Web browsers are applications to request and receive HTTP
- Web Server = Server

## NodeJS Express Server

- [Express Server](https://expressjs.com/en/starter/hello-world.html) is a very popular npm library exists to allow you to run your own HTTP server with NodeJS.
- Example

  ```js
  import express from 'express';

  const app = express();
  const port = 3000;

  // A quirk of express that is required in order for the data of many requests to be interpreted
  app.use(express.text());

  // Default URL
  app.get('/', (req, res) => {
    res.send('Hello World!');
  });

  // Custom URL
  app.get('/hey', (req, res) => {
    res.send('Hey!');
  });

  app.get('/bye/bye', (req, res) => {
    res.send('Bye Bye!');
  });

  // Start server
  app.listen(port, () => {
    console.log(`Listening on port ${port}`);
  });
  ```

# API

- An API (Application Programming Interface) refers to an interface exposed by a particular piece of software
- The most common usage of "API" is for Web APIs, which refer to a "contract" that a particular service provides. The interface of the service acts as a black box and indicates that for particular endpoints, and given particular input, the client can expect to receive particular output

## Web API

![](./1531-images/web-api.png)

## RESTful API

- A RESTful API is an application program interface (API) that uses HTTP requests to GET, PUT, POST and DELETE data
- Create Read Update Delete (CRUD) Operations

  | Method | Operation |
  | ------ | --------- |
  | POST   | Create    |
  | GET    | Read      |
  | PUT    | Update    |
  | DELETE | Delete    |

- Different CRUD properties require different approaches for input
  - For inputs:
    - `GET || DELETE`: via `req.query` (capture URL)
      - Make sure `GET` headers have `Content-Type` as `text/javascript`
    - `PUT || POST`: via `req.body` (capture body)
      - Mkae sure Body-content type = `application/json`
  - For outputs:
    - All outputs should be packaged up as JSON (`JSON.stringify(jsObject)`)
- Example (Method 1)

  ```ts
  // Method 1
  import express from 'express';

  const app = express();
  const port = 3001;

  app.use(express.text());

  // localhost:3001/apple?name=hayden&age=5&height=10
  app.get('/apple', (req, res) => {
    const name = req.query.name as string | undefined;
    res.send(
      JSON.stringify({
        msg: `Hi ${name}, thanks for getting apple!`,
      })
    );
  });

  // localhost:3001/add?num1=9&num2=11
  app.get('/add', (req, res) => {
    console.log(res.query);
    const num1 = parseInt(req.query.num1 as string);
    const num2 = parseInt(req.query.num2 as string);
    res.send(
      JSON.stringify({
        msg: `The sum is ${num1 + num2}!`,
      })
    );
  });

  // Same for .put and .delete
  app.post('/orange', (req, res) => {
    const body = JSON.parse(req.body);
    const name = body.name;
    res.send(
      JSON.stringify({
        msg: `Hi ${name}, thanks for posting orange!`,
      })
    );
  });

  app.listen(port, () => {
    console.log(`Listening on port ${port}`);
  });
  ```

- Example (Method 2)

  ```ts
  import express from 'express';

  const app = express();
  const port = 3001;

  //! Note difference here
  app.use(express.json());

  app.get('/apple', (req, res) => {
    const name = req.query.name;
    //! Note difference here
    res.json({
      msg: `Hi ${name}, thanks for getting apple!`,
    });
  });

  // Same for .put and .delete
  app.post('/orange', (req, res) => {
    //! Note absence of JSON.parse(body);
    const name = req.body.name;
    res.json({
      msg: `Hi ${name}, thanks for sending orange!`,
    });
  });

  app.listen(port, () => {
    console.log(`Listening on port ${port}`);
  });
  ```

## Talking to a Web Server

- How can we talk to a web server as a client?
  - API client
  - Web Browser
  - An NPM library: `sync-request`

## API Client

- API Client (ARC, Postman, Insomnia)

  - [ARC](https://chrome.google.com/webstore/detail/advanced-rest-client/hgmloofddffdnphfgcellkdfbfbjeloo)

- Example

  ```ts
  import express from 'express';

  const app = express();
  const port = 3001;

  //! Note difference here
  app.use(express.json());

  let x = null;
  let y = null;

  app.get('/coord', (req, res) => {
    res.json({
      x: x;
      y: y;
    });
    // Shortcut
    // res.json({ x, y });
  });

  // Same for .put and .delete
  app.put('/coord', (req, res) => {
    x = req.body.x;
    y = req.body.y;
    res.json({ x: x, y: y });
    // res.json({ x, y });
  });

  app.listen(port, () => {
    console.log(`Listening on port ${port}`);
  });
  ```

## Requests Library

- `npm install sync-request`
- Example

  - Make sure to run express server first (in another terminal)
    - E.g. `npm run ts-node src/4.2_crud.ts`
  - Run with `npm run ts-node src/4.2_requests.ts`

  ```ts
  import request from 'sync-request';

  const res1 = request('GET', 'http://localhost:3001/apple?name=Hayden');
  console.log(JSON.parse(String(res1.getBody())));

  const res2 = request('POST', 'http://localhost:3001/orange', {
    json: {
      name: 'Hayden',
    },
  });
  console.log(JSON.parse(String(res2.getBody())));
  ```

## Working with Jest

- Example 1

  - `npm run jest src/4.2_requests.test.ts`
  - `npm run jest` to run all tests on all files

  ```ts
  import request from 'sync-request';
  // Note qs = query string
  describe('Test Apple', () => {
    test('If it returns a name string successfully', () => {
      const res = request('GET', 'http://localhost:3001/apple', {
        qs: {
          name: 'Hayden',
        },
      });
      const bodyObj = JSON.parse(String(res.getBody()));
      expect(bodyObj.msg).toBe('Hi Hayden, thanks for sending apple!');
    });
  });
  // Sending JSON (Method 1)
  describe('Test Orange 1', () => {
    test('If it returns a name string successfully', () => {
      const res = request('POST', 'http://localhost:3001/orange', {
        body: JSON.stringify({ name: 'Hayden' }),
        headers: {
          'Content-type': 'application/json',
        },
      });
      const bodyObj = JSON.parse(String(res.getBody()));
      expect(bodyObj.msg).toBe('Hi Hayden, thanks for sending orange!');
    });
  });
  // Sending JSON (Method 2)
  describe('Test Orange 2', () => {
    test('If it returns a name string successfully', () => {
      const res = request('POST', 'http://localhost:3001/orange', {
        json: { name: 'Hayden' },
      });
      const bodyObj = JSON.parse(String(res.getBody()));
      expect(bodyObj.msg).toBe('Hi Hayden, thanks for sending orange!');
    });
  });
  ```

- Example 2

  ```ts
  import request from 'sync-request';

  type Method = 'GET' | 'POST' | 'PUT' | 'DELETE';

  const bodyStrToObj = (res: any) => JSON.parse(String(res.getBody()));

  const createRequest = (method: Method) => {
    const myNewFunction = (url: string, data: any) => {
      let payload = { json: data };
      if (method === 'GET' || method == 'DELETE') {
        payload = { qs: data };
      }
      const res = request(method, url, payload);
      return bodyStrToObj(res);
    };
    return myNewFunction;
  };

  const getRequest2 = createRequest('GET');
  const postRequest2 = createRequest('POST');

  const getRequest = (url: string, data: any) => {
    const res = request('GET', url, {
      qs: data,
    });
    const bodyObj = JSON.parse(String(res.getBody()));
    return bodyObj;
  };

  const postRequest = (url: string, data: any) => {
    const res = request('POST', url, {
      json: data,
    });
    const bodyObj = JSON.parse(String(res.getBody()));
    return bodyObj;
  };

  describe('Test Apple', () => {
    test('If it returns a name string successfully', () => {
      const bodyObj = getRequest('http://localhost:3001/apple', { name: 'Hayden' });
      expect(bodyObj.msg).toBe('Hi Hayden, thanks for sending apple!');
    });
  });

  describe('Test Orange', () => {
    test('If it returns a name string successfully', () => {
      const bodyObj = postRequest('http://localhost:3001/orange', { name: 'Hayden' });
      expect(bodyObj.msg).toBe('Hi Hayden, thanks for sending orange!');
    });
  });
  ```

## Tips

- Make `node` auto restart if new files are compiled/changed
  - `npm install --save-dev nodemon`
  - Replace `node` with `nodemon` in `package.json`
  - Run `npm run nodemon` in a **separate** terminal
- Make `tsc` auto run if source files are changed
  - Add `--watch` flag to `tsc` command
  - Run `npm run tsc` in a **separate** terminal
